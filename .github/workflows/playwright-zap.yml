name: Playwright + ZAP Scan

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL for ZAP scan'
        required: false
        default: ''
  push:
    branches:
      - main

jobs:
  e2e_and_zap:
    runs-on: ubuntu-latest
    # job-level environment to avoid repeating values (DRY)
    env:
      PLAYWRIGHT_IMAGE: mcr.microsoft.com/playwright:v1.57.0-noble
      ZAP_IMAGE: ghcr.io/zaproxy/zaproxy:stable
      ZAP_WORKDIR: /zap/wrk
      ZAP_REPORT: /zap/wrk/zap-report.html
      DEFAULT_TARGET: https://playwright.dev/docs/docker
      # derive TARGET from input when present, otherwise use DEFAULT_TARGET
      TARGET: ${{ github.event.inputs.target_url || 'https://playwright.dev/docs/docker' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure tools (jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Run login + export session (Playwright Docker)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/work -w /work \
            "$PLAYWRIGHT_IMAGE" \
            bash -lc "npm ci && node scripts/mock-session.cjs"

      - name: Assert session.json exists
        run: |
          echo "Checking for session.json produced by the Playwright step..."
          if [ ! -f session.json ]; then
            echo "ERROR: session.json not found in workspace. Make sure the Playwright step created it." >&2
            ls -la
            exit 1
          fi
          echo "session.json found:" && cat session.json

      - name: Create ZAP cookie injector script (Python hook)
        run: |
          cat > scripts/load-session.py <<'PY'
          import os

          def sendingRequest(msg, initiator, helper):
              jsession = os.getenv('JSESSIONID')
              if jsession:
                  msg.getRequestHeader().setHeader('Cookie', 'JSESSIONID=' + jsession)
          PY

      - name: Export JSESSIONID from session.json
        run: |
          echo "session.json content:" && cat session.json
          # Try several common shapes for session JSON to extract JSESSIONID
          VALUE=$(jq -r '.JSESSIONID // .JSESSIONID.value // (.cookies[]? | select(.name=="JSESSIONID") | .value) // empty' session.json)
          if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
            echo "ERROR: JSESSIONID not found in session.json" >&2
            echo "Tried selectors: .JSESSIONID, .JSESSIONID.value, .cookies[] | select(.name==\"JSESSIONID\") .value" >&2
            exit 1
          fi
          echo "JSESSIONID=$VALUE" >> $GITHUB_ENV

      - name: Prepare ZAP report file (simple approach)
        run: |
          echo "Preparing zap-report.html so the container can write it"
          touch zap-report.html
          chmod 666 zap-report.html

      - name: Run ZAP Full Scan
        run: |
          set -euxo pipefail
          echo "ZAP target: $TARGET"
          if [ -z "$TARGET" ]; then
            echo "ERROR: target_url is empty" >&2
            exit 1
          fi
          echo "Running ZAP container to scan $TARGET (simple mode)"
          docker run --rm \
            -e JSESSIONID="$JSESSIONID" \
            -v "${{ github.workspace }}":$ZAP_WORKDIR:rw \
            "$ZAP_IMAGE" zap-full-scan.py \
              -t "$TARGET" \
              -d \
              -I \
              --hook=$ZAP_WORKDIR/scripts/load-session.py \
              -r $ZAP_REPORT

      - name: "Post-scan: show report head and fix ownership"
        if: always()
        run: |
          echo "Post-scan: checking for zap-report.html"
          if [ -f zap-report.html ]; then
            echo "zap-report.html found; showing first 80 lines:"
            head -n 80 zap-report.html || true
            RUNNER_UID=$(id -u)
            echo "Fixing ownership to UID $RUNNER_UID"
            chown $RUNNER_UID zap-report.html || true
          else
            echo "zap-report.html not found"
          fi

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.html
          if-no-files-found: warn
