name: Playwright + ZAP Scan

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL for ZAP scan'
        required: false
        default: ''
  push:
    branches:
      - main

jobs:
  e2e_and_zap:
    runs-on: ubuntu-latest
    # job-level environment to avoid repeating values (DRY)
    env:
      PLAYWRIGHT_IMAGE: mcr.microsoft.com/playwright:v1.57.0-noble
      ZAP_IMAGE: ghcr.io/zaproxy/zaproxy:stable
      ZAP_WORKDIR: /zap/wrk
      ZAP_REPORT: /zap/wrk/zap-report.html
      DEFAULT_TARGET: https://playwright.dev/docs/docker
      # derive TARGET from input when present, otherwise use DEFAULT_TARGET
      TARGET: ${{ github.event.inputs.target_url || 'https://playwright.dev/docs/docker' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure tools (jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Run login + export session (Playwright Docker)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/work -w /work \
            "$PLAYWRIGHT_IMAGE" \
            bash -lc "npm ci && node scripts/mock-session.cjs"

      - name: Assert session.json exists
        run: |
          echo "Checking for session.json produced by the Playwright step..."
          if [ ! -f session.json ]; then
            echo "ERROR: session.json not found in workspace. Make sure the Playwright step created it." >&2
            ls -la
            exit 1
          fi
          echo "session.json found:" && cat session.json

      - name: Create ZAP cookie injector script (Python hook)
        run: |
          cat > scripts/load-session.py <<'PY'
          import os

          def sendingRequest(msg, initiator, helper):
              jsession = os.getenv('JSESSIONID')
              if jsession:
                  msg.getRequestHeader().setHeader('Cookie', 'JSESSIONID=' + jsession)
          PY

      - name: Export JSESSIONID from session.json
        run: |
          echo "session.json content:" && cat session.json
          # Try several common shapes for session JSON to extract JSESSIONID
          VALUE=$(jq -r '.JSESSIONID // .JSESSIONID.value // (.cookies[]? | select(.name=="JSESSIONID") | .value) // empty' session.json)
          if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
            echo "ERROR: JSESSIONID not found in session.json" >&2
            echo "Tried selectors: .JSESSIONID, .JSESSIONID.value, .cookies[] | select(.name==\"JSESSIONID\") .value" >&2
            exit 1
          fi
          echo "JSESSIONID=$VALUE" >> $GITHUB_ENV

      - name: Run ZAP Full Scan
        run: |
          set -euxo pipefail
          echo "ZAP target: $TARGET"
          if [ -z "$TARGET" ]; then
            echo "ERROR: target_url is empty" >&2
            exit 1
          fi
          echo "Running ZAP container to scan $TARGET as the runner UID/GID (with fallback)"
          RUNNER_UID=$(id -u)
          RUNNER_GID=$(id -g)
          echo "Using UID:GID = $RUNNER_UID:$RUNNER_GID"

          # Try running as the runner UID/GID first (preferred for security).
          set +e
          docker run --rm \
            --user $RUNNER_UID:$RUNNER_GID \
            -e JSESSIONID="$JSESSIONID" \
            -v "${{ github.workspace }}":$ZAP_WORKDIR:rw \
            "$ZAP_IMAGE" zap-full-scan.py \
              -t "$TARGET" \
              -d \
              -I \
              --hook=$ZAP_WORKDIR/scripts/load-session.py \
              -r $ZAP_REPORT  > zap-docker.log 2>&1
          RC=$?
          set -e

          if [ $RC -eq 0 ]; then
            echo "ZAP run succeeded as runner UID/GID"
          else
            echo "ZAP run failed with rc=$RC. Showing last 200 lines of container log:"
            tail -n 200 zap-docker.log || true
            # Detect common startup failure message and retry as root if present
            if grep -qi "Failed to start ZAP" zap-docker.log || grep -qi "ERROR" zap-docker.log; then
              echo "Detected ZAP startup failure; retrying as root after creating writable report file"
              # Prepare a writable report file so non-root root process inside container can write it
              touch zap-report.html || true
              chmod 666 zap-report.html || true
              docker run --rm \
                -e JSESSIONID="$JSESSIONID" \
                -v "${{ github.workspace }}":$ZAP_WORKDIR:rw \
                "$ZAP_IMAGE" zap-full-scan.py \
                  -t "$TARGET" \
                  -d \
                  -I \
                  --hook=$ZAP_WORKDIR/scripts/load-session.py \
                  -r $ZAP_REPORT
            else
              echo "ZAP failed but no clear startup failure detected; failing job (rc=$RC)" >&2
              exit $RC
            fi
          fi

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.html
