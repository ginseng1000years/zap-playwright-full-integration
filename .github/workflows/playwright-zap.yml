name: Playwright + ZAP Scan

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  e2e_and_zap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run login + export session (Playwright Docker)
        run: |
          docker run --rm \
            -v "$(pwd)":/work -w /work \
            mcr.microsoft.com/playwright:v1.57.0-noble \
            bash -lc "npm ci && node scripts/mock-session.cjs"

      - name: Check session.json exists
        run: |
          echo "Checking for session.json produced by the Playwright step..."
          if [ ! -f session.json ]; then
            echo "ERROR: session.json not found in workspace. Make sure the Playwright step created it." >&2
            ls -la
            exit 1
          fi
          echo "session.json found:" && cat session.json

      # --- ZAP PHASE ---

      - name: Create ZAP cookie injector script (Python hook)
        run: |
          cat << 'EOF' > scripts/load-session.py
          import os

          def sendingRequest(msg, initiator, helper):
              jsession = os.getenv('JSESSIONID')
              if jsession:
                  msg.getRequestHeader().setHeader('Cookie', 'JSESSIONID=' + jsession)
          EOF

      - name: Read session.json and export as ENV
        run: |
          export VALUE=$(jq -r '.JSESSIONID' session.json)
          echo "JSESSIONID=$VALUE" >> $GITHUB_ENV

      - name: Run ZAP Full Scan
        run: |
          docker run \
            -e JSESSIONID=${{ env.JSESSIONID }} \
            -v "$(pwd)":/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable zap-full-scan.py \
              -t "https://your-app-url.com" \
              -d \
              -I \
              --hook=/zap/wrk/scripts/load-session.py \
              -r zap-report.html

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.html
